<!doctype html>
<html>
    <head>
        <title>camera</title>
        <meta charset='utf8'>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="../bower_components/bootstrap/dist/css/bootstrap.min.css">

        <script src="https://skyway.io/dist/0.3/peer.js"></script>
        <script src="../bower_components/eventemitter3/index.js"></script>
        <script src="../lib/peer_custom_mesg.js"></script>
        <script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>
        <script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    </head>
    <body>
      <div class="container">
        <div class="page-header">
          <h1>A Dashboard for WebRTC Cam</h1>
          <p class="lead">Dashboard for local WebRTC cam</p>
        </div>
        <h3>meta info</h3>
        <p>
        <table class="table">
          <tr><td><strong>location</strong></td><td><span id="location"></span></td></tr>
          <tr><td><strong>name</strong></td><td><span id="name"></span></td></tr>
        </table>
        </p>
        <h3>local video view</h3>
        <p>
        <video id="mycam" width="100%" autoplay></video>
        </p>
      </div>
    </body>
    <script>
        //////////////////////////////////////////////////////////////
        // utility and dummy functions for demonstrations

        // make random number, it is used for making my peer id.
        var makeRandom = (seed) => {
            return Math.floor(Math.random(seed)*seed);
        }

        // for demonstration, camera's profile of location name is randomly determined
        var loc = (function(){
            var locations = ["tokyo", "oosaka", "palo alto", "mountain view"];
            var len = locations.length
                , idx = Math.floor(Math.random() * len);

            return locations[idx]
        }());

        // for demonstration, camera's profile of name is randomly determined
        var name = (function(){
            var names = ["Office", "Home", "Park", "restaulant"];
            var len = names.length
                , idx = Math.floor(Math.random() * len);

            return names[idx]
        }());

        ////////////////////////////////////////////////////////////
        // codes for services

        var myid = "camera"+makeRandom(10000000000);
        var peer = new Peer(myid, {'key': 'dbe1b9ed-5a52-4488-a592-c451daf74206'});
        var peerCustomMesg, call;

        // display this camera's profile
        $("#location").text(loc);
        $("#name").text(name);

        // when established connection to SkyWay signaling server
        // setup custom message
        peer.on("open", (id) => {
            console.log(id);
            peerCustomMesg = new PeerCustomMesg(peer, "CAMERAMONITOR");

            peerCustomMesg.on("message", function(mesg){
                console.log("receive custom message: ",mesg.srcPeerID, mesg.data )
                handleMesg(mesg);
            })
        })

        // message handler for custom message from monitor site
        var handleMesg = (mesg) => {
            var monitorID = mesg.srcPeerID
                , req = mesg.data;

            if(req.method === "GET") {
                switch(req.resource){
                // when profile request, send profile info with name and location
                case '/profile':
                    peerCustomMesg.send(monitorID, {
                        "resource": "/profile",
                        "response": {
                            "name": name,
                            "location": loc
                        }
                    });
                    break;
                // when livestream request, response ok message then star WebRTC
                // video streaming service
                case '/livestream':
                    // todo start WebRTC live stream
                    console.log("attempt to start live stream")

                    peerCustomMesg.send(monitorID, {
                        "resource": "/livestream",
                        "response": "ok"
                    });

                    startVideo(monitorID);
                    break;
                default:
                    break;
                }
            }
        }

        // start obtaining live stream from camera, then start establishing WebRTC
        // video streaming
        var startVideo = (monitorID) => {
          navigator.webkitGetUserMedia({"video": true, "audiio": false}, (stream) => {
            var url = URL.createObjectURL(stream);
            $("#mycam").prop("src", url);
            call = peer.call(monitorID, stream);
          }, (err) => {
            console.warn(err);
          });
        }
    </script>
</html>
